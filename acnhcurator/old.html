<!DOCTYPE html>
<html>
<head>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap');
    
    :root {
      --white: #FFFAE4;
      --offwhite: #EEE2CA;
      --yellow: #FEED9F;
      --orange: #FECE09;
      --brown: #847558;
      --cyan: #00DEBA;
    }
    
    body {
      background-color: var(--offwhite);
      color: var(--brown);
      font-family: 'Quicksand', sans-serif;
      user-select: none;
      text-transform: lowercase !important;
      margin: 0;
    }
    
    main {
      width: 80vw;
      margin: 8rem auto;
      text-align: center;
    }
    
    @keyframes card_enter {
      from {opacity: 0; transform: translateY(1rem);}
    }
    .species_card {
      animation: 1s card_enter;
      background-color: var(--white);
      border: solid 0.125rem var(--white);
      border-bottom-width: 0.5rem;
      width: 20rem;
      height: 10rem;
      position: relative;
      display: inline-block;
      margin: 0.5rem;
      overflow: hidden;
      transition: 0.1s width, 0.1s height, 0.2s background-color, 0.2s opacity, 0.2s transform, 0.2s outline;
      border-radius: 0.25rem;
      cursor: pointer;
    }
    
    .species_card > * {
      position: absolute;
      font-size: 1rem;
      margin: 0;
      transition: 0.2s left, 0.2s top;
    }
    
    .species_card[collected="true"] {
      opacity: 0.2;
      cursor: default;
      transform: none;
      border-bottom-width: 0.125rem;
    }
    
    .species_card img {
      left: 0;
      width: 4rem;
      height: 4rem;
      padding: 0.5rem;
      transition: 0.2s padding, 0.2s border-radius;
    }
    
    .species_card h1 {
      top: 1.75rem;
      left: 5rem;
      text-align: center;
      width: 14rem;
    }
    
    .species_card h2 {
      top: 1rem;
      left: 1rem;
    }
    
    .species_card[minimized="false"] img {
      border-bottom-right-radius: 0.25rem;
    }
    .species_card[minimized="true"] {
      height: 4rem;
    }
    .species_card[minimized="true"] img {
      padding-top: 0;
      padding-bottom: 1rem;
    }
    .species_card[minimized="true"] h1 {
      top: 1.25rem;
    }
    .species_card[minimized="verytrue"] {
      height: 5rem;
      width: 5rem;
    }
    
    /* accents */
    .species_card[accent="none"] {border-color: var(--white); background-color: var(--offwhite);}
    .species_card[accent="none"] img {background-color: var(--offwhite);}
    .species_card[accent="seasonal"] {border-color: var(--brown);}
    .species_card[accent="seasonal"] img {background-color: var(--white);}
    .species_card[accent="rn"] {border-color: var(--cyan);}
    .species_card[accent="urgent"] {border-color: var(--cyan);}
    .species_card[accent="urgent"] img {background-color: var(--cyan);}
    
    header {
      padding: 2rem 30vh;
      z-index: 1;
      text-align: center;
      margin-bottom: -4rem;
      margin-top: 4rem;
    }
    
    header input[type="checkbox"] {
      accent-color: var(--cyan);
    }
    
    main b {
      display: block;
      text-align: center;
      margin: 2rem 0;
      margin-top: 8rem;
      font-size: 2rem;
    }
    
    nav {
      margin: 0 auto;
      padding: 1rem;
      text-align: center;
      border-radius: 0.25rem;
    }
    
    nav span {
      width: 8rem;
      padding: 0.5rem 0;
      text-align: center;
      display: inline-block;
      background-color: var(--offwhite);
      margin-right: 0.5rem;
      border: solid 0.125rem var(--white);
      border-radius: 0.25rem;
      transition: 0.2s;
    }
    
    #nav_profiles span:hover, #nav_display span:hover {
      transform: translateY(-0.25rem);
      box-shadow: 0 0.25rem var(--brown);
    }
    
    select, input {
      font-family: inherit;
      text-transform: inherit;
      display: block;
      margin: 0 auto;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      width: 16rem;
      padding: 0.5rem;
    }
  </style>
</head>
<body onunload="save();">
  <header>
    <nav id="nav_profiles">
      profiles&emsp;
      <span onclick="switch_profile(0, this);" style="background-color: var(--white); cursor: pointer;">#1</span>
      <span onclick="switch_profile(1, this);" style="cursor: pointer;">#2</span>
      <span onclick="switch_profile(2, this);" style="cursor: pointer;">#3</span>
      <span onclick="switch_profile(3, this);" style="cursor: pointer;">#4</span>
    </nav>
    <nav id="nav_display">
      display&emsp;
      <span onclick="set_density('false', this);" style="background-color: var(--white); cursor: pointer;">details</span>
      <span onclick="set_density('true', this);" style="cursor: pointer;">dense</span>
      <span onclick="set_density('verytrue', this);" style="cursor: pointer;">super dense</span>
    </nav>
    <nav id="nav_key">
      key&emsp;
      <span style="background-color: var(--cyan); border-color: var(--cyan);">Urgent</span>
      <span style="background-color: var(--white); border-color: var(--cyan);">Available</span>
      <span style="background-color: var(--white); border-color: var(--brown);">Seasonal</span>
      <span style="background-color: var(--offwhite); border-color: var(--white);">Unavailable</span>
    </nav>
  </header>
  <main></main>
  <script src="catalogue.js"></script>
  <script>
    let save_data = localStorage.getItem("acnh_species_data");
    /* save_data {collection, collection_names, south} */
    save_data = save_data ? JSON.parse(save_data) : {
      collection: [[],[],[],[]],
      south: false
    };
    console.log(save_data);
    let collection = save_data.collection;
    let current_collection = 0;
    
    for (species of catalogue) {
      species.img = "https://acnhcritterpedia.com/images/critters/"+{
        'Fish': 'fish',
        'Bug': 'bug',
        'Deep Sea': 'deep'
      }[species.category]+"/webp/"+species.name.toLowerCase().replaceAll("'","").replaceAll(" ", "_")+".webp";
    }
  
    //todo: rotate all the month arrays if southern hemisphere.
    
    let month_names = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let month_names_long = ["January", "Febuary", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    //for (let i = 0; i < 12; i++) month_names[i] += ".";
    let hour_names = ["12AM", "1AM", "2AM", "3AM", "4AM", "5AM", "6AM", "7AM", "8AM", "9AM", "10AM", "11AM", "12PM", "1PM", "2PM", "3PM", "4PM", "5PM", "6PM", "7PM", "8PM", "9PM", "10PM", "11PM"];
    let current_month = new Date().getMonth();
    let current_hour = new Date().getHours();
    
    function switch_profile(n, el = null) {
      current_collection = n;
      make_main();
      categorize();
      if (el) {
        for (sib of el.parentElement.querySelectorAll("span")) {
          sib.style.backgroundColor = "var(--offwhite)";
        }
        el.style.backgroundColor = "var(--white)";
      }
    }
    
    make_main();
    categorize();
    function make_main() {
      while (document.querySelector("main").firstChild) document.querySelector("main").firstChild.remove();
      //make the elements for current_collection
      for (let i = 0; i < catalogue.length; i++) {
        let species = catalogue[i];
        let div = document.querySelector("main").appendChild(document.createElement("div"));
        div.setAttribute("catalogue_number", i);
        div.setAttribute("class", "species_card");
        div.setAttribute("minimized", "false");
        div.setAttribute("collected", collection[current_collection].includes(species.name) ? "true" : "false");
        //top of card
        let img = div.appendChild(document.createElement("img"));
        img.setAttribute("src", species.img);
        let h1 = div.appendChild(document.createElement("h1"));
        h1.innerText = species.name;
        //times available
        let h2 = div.appendChild(document.createElement("h2"));
        h2.innerText = text_months(species) + ", " + text_hours(species);
        h2.style.top = "5.5rem";
        //context
        let h3 = div.appendChild(document.createElement("h2"));
        h3.innerText = species.context;
        h3.style.top = "6.75rem";
        //next available
        let h4 = div.appendChild(next_available_html_element(species));
        h4.style.top = "8rem";
        //deadline
        let h5 = div.appendChild(expires_html_element(species));
        h5.style.top = "9.25rem";
        //price
        let h6 = div.appendChild(document.createElement("h2"));
        h6.style.top = "8rem";
        h6.style.right = "1rem";
        h6.style.textAlign = "right";
        h6.innerText = species.value.toLocaleString()+" bells";
        //onclick
        div.onclick = function() {
          let i = this.getAttribute("catalogue_number");
          let species = catalogue[i];
          if (collection[current_collection].includes(species.name)) {
            collection[current_collection] = collection[current_collection].filter((x) => x != species.name);
          } else {
            collection[current_collection].push(species.name);
          }
          console.log(collection[current_collection]);
          this.setAttribute("collected", collection[current_collection].includes(species.name) ? "true" : "false");
          document.querySelector("#nav_profiles").children[current_collection].innerText = "#"+(current_collection+1)+" ("+100*collection[current_collection].length/catalogue.length+"%)";
        }
      }
    }
    
    function set_density(val, el = null) { //"true" or "false"
      for (div of document.querySelectorAll(".species_card"))
        div.setAttribute("minimized", val);
      if (el) {
        for (sib of el.parentElement.querySelectorAll("span")) {
          sib.style.backgroundColor = "var(--offwhite)";
        }
        el.style.backgroundColor = "var(--white)";
      }
    }
    
    function map_bool_array_to_text(arr, labels, always_label, never_label) {
      let n = arr.length;
      //check for always
      let always = true;
      for (a of arr) if (!a) always = false;
      if (always) return always_label;
      //iterate through array. when pickup month, +" x". when drop month, +"-x"
      let txt = [];
      let current_run_start = null;
      for (let i = 0; i < n || current_run_start; i++) {
        let prev_active = arr[(i+n-1)%n];
        if (arr[i%n] && !prev_active && !current_run_start) {
          current_run_start = labels[i];
        }
        if (!arr[i%n] && current_run_start) {
          txt.push(current_run_start + "-" + labels[(i+n-1)%n]);
          current_run_start = null;
        }
      }
      return txt.length ? txt.join(" & ") : never_label;
    }
    
    function text_months(species) {
      return map_bool_array_to_text(species.months, month_names, "All year", "Never");
    }
    function text_hours(species) {
      return map_bool_array_to_text(species.hours, hour_names, "all day", "Never");
    }
    
    function available(species, date = new Date()) { //0 not this month, 1 different time of day, 2 right now
      let month_satisfied = species.months[date.getMonth()];
      let hour_satisfied = species.hours[date.getHours()];
      if (month_satisfied && hour_satisfied) return 2;
      if (month_satisfied) return 1;
      return 0;
    }
    
    function next_available(species) {
      if (available(species) == 2) return "Available now!";
      let date = new Date();
      let [og_month, og_hour] = [date.getMonth(), date.getHours()];
      while (available(species, date) != 2) {
        date.setHours(date.getHours() + 1);
      }
      let [nu_month, nu_hour] = [date.getMonth(), date.getHours()];
      if (nu_month == og_month) {
        //say 'Tomorrow at (hour)'
        return "Next available at "+hour_names[nu_hour];
      } else {
        //say '(hour) in (month)'
        return "Available in "+month_names_long[nu_month];
      }
    }
    
    function expires_html_element(species) { //lowkey gives a "deadline" of when u have to get it. in terms of months
      let element = document.createElement("h2");
      return element;
    }
    
    function next_available_html_element(species) {
      let element = document.createElement("h2");
      element.innerText = next_available(species);
      element.style.color = "var(--brown)";
      if (element.innerText.includes("now")) element.style.color = "var(--cyan)";
      //if (element.innerText.includes("available at ")) element.style.color = "var(--cyan)";
      return element;
    }
    
    setInterval(save, 1000*60);
    function save() {
      localStorage.setItem("acnh_species_data", JSON.stringify(save_data));
    }
    
    function categorize() { //highlight the elements / sort
      let urgent_ones = [];
      for (let i = 0; i < catalogue.length; i++) {
        let species = catalogue[i];
        let element = document.querySelector("div[catalogue_number=\""+i+"\"]");
        element.setAttribute("accent", "none");
        if (species.months[new Date().getMonth()]) {
          element.setAttribute("accent", "seasonal");
          if (species.hours[new Date().getHours()]) element.setAttribute("accent", "rn");
        }
        let all_year = true;
        for (x of species.months) if (!x) all_year = false;
        if (!all_year && species.months[new Date().getMonth()]) {
          for (let i = new Date().getMonth(); true; i++) if (!species.months[i]) {
            let distance = i - new Date().getMonth();
            if (distance == 1) {
              element.setAttribute("accent", "urgent");
              urgent_ones.push(element);
            }
            break;
          }
        }
      }
      document.querySelector("main").appendChild(sectioner("Leaving in "+month_names_long[(new Date().getMonth()+1)%12]+ " (Urgent!)"));
      for (el of urgent_ones) {
        el.remove();
        document.querySelector("main").appendChild(el);
      }
      let last_category = null;
      for (el of document.querySelectorAll(".species_card")) if (!urgent_ones.includes(el)) {
        el.remove();
        let species = catalogue[el.getAttribute("catalogue_number")];
        if (species.category != last_category) {
          last_category = species.category;
          document.querySelector("main").appendChild(sectioner(last_category));
        }
        document.querySelector("main").appendChild(el);
      }
    }
    
    function sectioner(text) {
      let b = document.createElement("b");
      b.innerText = text;
      return b;
    }
  </script>
</body>
</html>