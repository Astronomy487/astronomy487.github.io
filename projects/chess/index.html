<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="icon.png">
  <title id="title">Chess Sandbox</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500&display=swap');
    
    @font-face {
      font-family: "chess font";
      src: url('CASEFONT.TTF') format('truetype');
    }
    
    :root {
      --black: #292929;
      --white: #EDEDEA;
      --gray: #555;
      --square-dark: #6388a5;
      --square-light: #afbecc;
      --color: #FF7300;
    }
    
    body {
      user-select: none;
      margin: 0;
      background-color: var(--black);
      font-family: Inter, sans-serif;
      color: var(--white);
      overflow-x: hidden;
    }
    
    main {
      max-height: 94vh;
      margin-top: 3vh;
      position: absolute;
      width: 100%;
      top: 50%;
      transform: translateY(-50%) translateY(-3vh);
    }
    
    table {
      border-collapse: collapse;
      transition: transform 1s;
      margin: auto;
    }
    
    ::selection {
      background: var(--white);
      color: var(--black);
    }
    
    td {
      width: 5rem;
      height: 5rem;
      text-align: center;
      font-size: 4rem;
      background-color: var(--square);
    }
    
    td[parity="0"] {--square: var(--square-light); --not-square: var(--square-dark);}
    td[parity="1"] {--square: var(--square-dark); --not-square: var(--square-light);}
    
    span[team] {
      paint-order: stroke fill;
      -webkit-text-stroke: 0.125em var(--black);
      display: block;
      transition: transform 0s;
      text-shadow: 0 0.0625em 0.125em var(--black);
      font-family: 'chess font';
    }
    
    span[team="0"] {color: var(--white);}
    span[team="1"] {color: var(--black); -webkit-text-stroke-color: var(--white);}
    span[team="2"] {color: #3B4FE7;}
    span[team="3"] {color: #EE2B1A;}
    span[team="4"] {color: #ECAD19;}
    
    td[oob="true"] {
      opacity: 0;
    }
    
    td[highlight="owned"] {
      cursor: pointer;
    }
    td[highlight="origin"] {
      background-color: var(--color);
      cursor: pointer;
    }
    td[highlight="destination"] {
      cursor: pointer;
      box-shadow: inset 0.25rem 0.25rem var(--square), inset -0.25rem -0.25rem var(--square), inset 0.5rem 0.5rem var(--color), inset -0.5rem -0.5rem var(--color);
    }
    td[highlight="just_happened"] {
      box-shadow: inset 0.25rem 0.25rem var(--square), inset -0.25rem -0.25rem var(--square), inset 0.5rem 0.5rem var(--not-square), inset -0.5rem -0.5rem var(--not-square);
    }
    
    td.coords {
      font-size: 1.25rem;
      width: 2rem;
      height: 2rem;
      color: var(--gray);
    }
    
    a {
      color: var(--color);
      text-decoration: none;
      cursor: pointer;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    button {
      background-color: var(--color);
      border: none;
      font-size: 1rem;
      font-family: inherit;
      width: 8rem;
      padding: 0.5rem 0;
      cursor: pointer;
      margin: 1rem 0;
      margin-left: calc(100% - 8rem);
      display: block;
    }
    
    button:hover {
      background-color: var(--white);
    }
    
    button:hover::after {content: ' ->';}
    button:hover::before {content: '-> ';}
    
    #menu {
      width: 100%;
      user-select: text;
      padding-bottom: 6rem;
    }
    
    #menu h1 {
      font-weight: normal;
      font-size: 2rem;
      width: 32rem;
      margin: 4rem auto;
      text-align: center;
    }
    
    .setup {
      width: 32rem;
      margin: 1rem auto;
    }
    
    .setup h2 {
      font-size: 2rem;
      font-weight: normal;
      margin: 1rem 0;
      color: var(--color);
    }
    
    .setup button {
      background-color: var(--black);
      color: var(--white);
    }
    
    .setup button:hover {
      background-color: var(--color);
      color: var(--black);
    }
    
    #menu input {
      background-color: var(--black);
      color: var(--white);
      font-family: inherit;
      border: none;
      padding: 0.5rem 0;
      font-size: 1rem;
      text-align: center;
      margin: 1rem 0;
      margin-bottom: 0;
      border: solid 0.125rem var(--gray);
      width: calc(100% - 0.25rem);
    }
    
    #menu input:focus {
      outline: none;
      color: var(--color);
    }
    
    #sidebar {
      position: fixed;
      width: 16rem;
      bottom: 0;
      left: 0;
      padding: 1rem;
      background-color: var(--black);
      font-size: 1.125rem;
    }
    
    #sidebar p {
      margin: 0;
      margin-top: 0.5rem;
    }
    
    #modal {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--black);
      width: 32rem;
      padding: 1rem 2rem;
      min-height: 16rem;
      user-select: text;
      border: solid 0.125rem var(--gray);
    }
    
    #modal h1 {
      font-weight: normal;
      margin: 1rem 0;
      color: var(--color);
      
      /* margin: -1rem -2rem;
      background-color: var(--color);
      padding: 1rem;
      color: var(--white);
      margin-bottom: 2rem;
      text-align: center; */
    }
    
    #modal div {
      margin: 0.25rem 0;
    }
    
    #modal label {
      padding-left: 1rem;
    }
    
    #modal hr {
      border: none;
      margin: 1rem 0;
      height: 0.125rem;
      background-color: var(--gray);
      width: 50%;
    }
    
    select {
      margin: 0.25rem 0;
      margin-top: 0.5rem;
      background-color: inherit;
      border: none;
      font-family: inherit;
      color: inherit;
      font-size: inherit;
    }
    
    select:focus {
      color: var(--color);
      outline: none;
    }
    
    option {
      color: var(--white);
    }
  </style>
  <style id="rotation_css"></style>
</head>
<body>
  <script src="script.js"></script>
  <script src="common_pieces.js"></script>
  <main><table id="display_table"></table></main> <!-- game board -->
  <div id="sidebar">
    <!--<p><a onclick="undo_turn(teams);">Undo to last turn</a></p>-->
    <p id="current_turn_display"></p>
    <p>Using <a id="ruleset_link" target="_blank"></a></p>
    <p><a onclick="window.location.href = (''+location).substring(0, (''+location).indexOf('?'));">Home</a></p>
  </div>
  <div id="menu">
    <table style="margin-top: 8rem; user-select: none;"><td style="background-color: var(--color); transform: scale(2); border-radius: 1rem;"><span team="1">v</span></td></table>
    <!--<table style="margin-top: 8rem; user-select: none; border-radius: 1rem; overflow: hidden;">
      <tr><td parity="0" highlight="destination"><span team="0">l</span></td>
      <td parity="1"></td></tr>
      <tr><td parity="1"></td>
      <td parity="0" highlight="origin"><span team="1">o</span></td></tr>
    </table>-->
    <h1>Chess Sandbox</h1>
    <div class="setup">
      <p>This is a generalized sandbox for playing chess and chess-adjacent games/variants.</p>
      <p>New pieces, board states, and other behaviors can be easily implemented in simple .js scripts. You can load and play a ruleset here:</p>
      <input id="url_loader" placeholder="put ruleset URL here...">
      <script>document.getElementById("url_loader").value = "";</script>
      <button onclick="location.href += '?' + document.getElementById('url_loader').value;">Load </button>
      <p>Alternatively, you can load a game by its FEN.</p>
      <input id="fen_loader" placeholder="put FEN here...">
      <script>document.getElementById("fen_loader").value = "";</script>
      <button onclick="location.href += '?fen:' + document.getElementById('fen_loader').value;">Load</button>
    </div>
    <div class="setup">
      <h2>Standard Game</h2>
      <p>Chess played with normal rules.</p>
      <button onclick="link_to_rules('standard')">Play</button>
    </div>
    <div class="setup">
      <h2>Chess960</h2>
      <p>The order of all pieces on the back rank is shuffled. Invented by Bobby Fischer in 1996. Called Chess960 because there are 960 possible arrangements.</p>
      <button onclick="link_to_rules('960')">Play</button>
    </div>
    <div class="setup">
      <h2>4 Players</h2>
      <p>Chess with 4 players on a unique board.</p>
      <button onclick="link_to_rules('4')">Play</button>
    </div>
    <div class="setup">
      <h2>Chaturanga / Shatranj</h2>
      <p>The ancient Indian/Iranian predecessor of chess. Mantri (queens) can only move diagonal one square. Gaja/elephants (bishops) hop 2 squares diagonally. And you can't even castle.</p>
      <button onclick="link_to_rules('chaturanga')">Play</button>
    </div>
    <div class="setup">
      <h2>Crossword Chess</h2>
      <p>Chess except it has random holes in the middle like a crossword puzzle.</p>
      <button onclick="link_to_rules('crossword')">Play</button>
    </div>
    <div class="setup">
      <p>Other variants I have prepared</p>
      <ul>
        <!--<li><a onclick="link_to_rules('2020')">2020 Election</a></li>-->
        <li><a onclick="link_to_rules('checkers')">Checkers</a></li>
        <li><a onclick="link_to_rules('double')">Double (16x12)</a></li>
        <li><a onclick="link_to_rules('periodictable')">Periodic Table Chess</a></li>
        <!--<li><a onclick="link_to_rules('gay')">Gay Chess</a></li>-->
        <!--<li><a onclick="link_to_rules('guillotine')">Guillotine</a></li>-->
        <li><a onclick="link_to_rules('lol')">League of Legends</a></li>
        <li><a onclick="link_to_rules('mini')">Mini (4x4)</a></li>
        <li><a onclick="link_to_rules('spacious')">Spacious</a></li>
        <li><a onclick="link_to_rules('totalrandom')">Chess9.8x10<sup>16</sup></a></li>
      </ul>
    </div>
  </div>
  <div id="modal"></div>
  <script>
    let filename = location.search;
    while (filename.startsWith("?")) filename = filename.substring(1);
    if (filename != "") {
      let shortened_filename = filename; while (shortened_filename.includes("/")) shortened_filename = shortened_filename.substring(shortened_filename.indexOf("/")+1);
      //we are playing game
      document.getElementById("menu").remove();
      //run appropriate script
      if (filename.startsWith("fen:")) {
        filename = filename.substring(4).replaceAll("%20", " ");
        rules_name = "Standard Game";
        rules_description = "Position loaded from FEN string <a>"+filename+"</a>";
        filename = filename.split(" "); //[0] is positions, [1] is whose move, [2] is castling (set .state=1 for rooks), [3] is any en passanted tiles. [4][5] move counters are ignored
        document.getElementById("ruleset_link").parentElement.remove();
        white_rook.state = 1;
        black_rook.state = 1;
        board = copy_board(board_from_simple_fen(filename[0]));
        turn = filename[1]=="w" ? 0 : 1;
        if (filename[2].includes("K") && board[7][7].type == c.rook) board[7][7].state = 0;
        if (filename[2].includes("Q") && board[7][0].type == c.rook) board[7][0].state = 0;
        if (filename[2].includes("k") && board[0][7].type == c.rook) board[0][7].state = 0;
        if (filename[2].includes("q") && board[0][0].type == c.rook) board[0][0].state = 0;
        //TODO: implement en passant check from fen
        rules_loaded(true);
      } else {
        let el = document.createElement("script");
        el.setAttribute("src", filename);
        el.setAttribute("type", "text/javascript");
        el.setAttribute("async", false);
        document.body.appendChild(el);
        el.addEventListener("load", function(){rules_loaded();});
        el.addEventListener("error", function(){
          //create the modal that can start the game
          let html = '';
          html += '<h1>Error</h1>';
          html += '<p>Something went wrong. I can\'t load the URL <a href="'+filename+'">'+filename+'</a> you gave me. Are you sure it exists?</p>';
          document.getElementById("modal").innerHTML = html;
        });
      }
      function rules_loaded(using_fen = false) {
        if (!using_fen) {
          document.getElementById("ruleset_link").href = filename;
          document.getElementById("ruleset_link").innerText = shortened_filename;
          document.getElementById("title").innerText = rules_name+" - Chess Sandbox";
        }
        //create the modal that can start the game
        let html = '';
        html += '<h1>'+rules_name+'</h1>';
        html += '<p>'+rules_description+'</p>';
        teams = 0;
        for (row of board) for (cell of row) if (cell.team != undefined) teams = Math.max(teams, cell.team);
        teams++;
        html += '<hr>';
        let player_team = Math.floor(Math.random()*teams);
        for (let i = 0; i < teams; i++) {
          html += '<div><input type="checkbox" id="ai_checkbox_'+i+'" name="ai_checkbox_'+i+'" '+(i!=player_team?'checked':'')+'><label for="ai_checkbox_'+i+'">Let CPU play as '+team_names[i]+'</label></div>';
        }
        html += '<select id="turn_select">';
        for (let i = 0; i < teams; i++) {
          html += '<option'+(i==turn?' selected':'')+'>'+team_names[i]+'</option>';
        }
        html += '</select><label>plays first</label>';
        html += '<hr>';
        html += '<div><input type="checkbox" id="rotation_checkbox" name="rotation_checkbox" checked><label for="rotation_checkbox">Rotate board on players\' turns</label></div>';
        html += '<div><input type="checkbox" id="coords_checkbox" name="coords_checkbox" checked><label for="coords_checkbox">Show coordinates</label></div>';
        html += '<button onclick="start_game();" style="margin-top: -2rem;">Start</button>';
        document.getElementById("modal").innerHTML = html;
      }
    } else {
      //we are on home screen
      document.getElementById("sidebar").remove();
      document.getElementById("modal").remove();
    }
    
    function link_to_rules(filename) {
      location.href += "?rules/" + filename + ".js";
    }
  </script>
</body>
</html>