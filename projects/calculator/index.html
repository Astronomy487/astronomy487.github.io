<!DOCTYPE html>
<html>
<head>
  <title>Modular calculator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@700&display=swap');
    
    body {
      margin: 0;
      user-select: none;
      background-color: #222;
      font-family: "Inter";
      font-weight: normal;
      --accent: #888;
    }
    
    /* @keyframes node_enter {from {opacity: 0; transform: scale(0.9) translateY(2rem);}} */
    @keyframes node_enter {from {opacity: 0; transform: translateY(50vh)} 60% {transform: translateY(-0.5vh)}}
    
    .node {
      background-color: var(--accent);
      color: white;
      display: inline-block;
      position: fixed;
      width: 16rem;
      padding-bottom: 2px;
      animation: node_enter 1s;
      border-radius: 0.25rem;
      box-shadow: 0 0 0.5rem #000;
      transition: box-shadow 0.1s, background-color 0.1s;
    }
    
    .node[dragging=true] {
      box-shadow: 0 0 1rem black;
    }
    
    .node header {
      padding: 0.5rem 2px;
      text-align: center;
      text-transform: uppercase;
      cursor: move;
    }
    
    .node[errored="true"] {
      --accent: #666 !important;
    }
    .node[errored="true"] span {
      color: red;
    }
    
    .node section {
      background-color: #000;
      padding: 0.5rem 0;
      margin: 2px;
      margin-bottom: 0;
      border-radius: 0.125rem;
    }
    
    .node-inputs {
      width: 50%;
      vertical-align: top;
      display: inline-block;
    }
    
    .node-input div {
      display: inline-block;
      background-color: #000;
      color: #000;
      outline: solid 2px var(--accent);
      width: 1rem;
      height: 1rem;
      line-height: 1rem;
      text-align: center;
      border-radius: 1rem;
      transform: translateX(-9px);
      transition: 0.1s;
      text-transform: uppercase;
    }
    
    .node-input[connected="true"] div {
      background-color: var(--accent);
      border-radius: 0;
    }
    
    .node-input[connected="true"] div:hover {
      background-color: white;
      outline-color: white;
      color: black;
      border-radius: 0;
    }
    
    .node-input label {
      color: #777;
      height: 0;
      display: block;
      width: 6.25rem;
      text-align: right;
      transform: translate(-116px, -22px);
      cursor: text;
    }
    
    .node-input label::before {content: ' ';}
    
    .node-input label:focus {
      outline: none;
      color: white;
    }
    
    .node-output label {
      color: #777;
      transition: color 0.1s;
      height: 0;
      display: block;
      max-width: 6.25rem;
      text-align: left;
      transform: translate(138px, -22px);
    }
    
    .node-outputs {
      width: 50%;
      display: inline-block;
      vertical-align: top;
    }
    
    .node-output {
      text-align: right;
    }
    
    .node-input, .node-output {
      transition: 0.1s;
      text-transform: lowercase;
    }
    
    .node-input span, .node-output span {
      display: inline-block;
      width: 6.375rem;
      padding: 2px 4px;
      transition: 0.1s;
      cursor: pointer;
    }
    
    .node-input[connected="true"] span {
      color: var(--accent);
    }
    
    .node-output span:hover, .node-input span:hover, .node-output span:focus, .node-input span:focus {
      background-color: #333;
    }
    
    .node-output[selected=true] span, .node-input[selected=true] span {
      background-color: white;
      color: var(--accent);
    }
    
    .node-output div {
      display: inline-block;
      background-color: var(--accent);
      width: 0.75rem;
      height: 0.75rem;
      line-height: 0.75rem;
      text-align: center;
      border-radius: 1rem;
      transform: translateX(7px);
      margin-left: 2px;
      transition: 0.1s;
    }
    
    .node-buttons {
      margin: 0 2px;
      background-color: #000;
      text-align: center;
      overflow: hidden;
      border-radius: 0.125rem;
      border-top: solid 0.125rem var(--accent);
    }
    
    .node-buttons button {
      font-family: inherit;
      background-color: inherit;
      border: none;
      color: #bbb;
      text-transform: lowercase;
      padding: 0.5rem 0;
      display: block;
      width: 100%;
      font-weight: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.1s;
    }
    
    .node-buttons button:hover, .node-buttons button:focus {
      background-color: #222;
      color: white;
    }
    
    .node textarea {
      background-color: #000;
      margin: 0.125rem;
      border: none;
      color: white;
      margin-bottom: 0;
      resize: none;
      width: calc(100% - 1.25rem);
      border-radius: 0.125rem;
      padding: 0.5rem 0.125rem;
      font-family: inherit;
      font-weight: inherit;
      font-size: 0.875rem;
      padding: 0.5rem;
      overflow: hidden;
      height: 6rem;
      display: none;
    }
    
    .node textarea:focus {
      background-color: #222;
      outline: none;
    }
    
    .node:hover textarea {
      display: none;
    }
    
    nav {
      position: fixed;
      bottom: 1.5rem;
      left: 1.5rem;
      font-size: 0;
    }
    
    nav a {
      display: inline-block;
      width: 2rem;
      height: 2rem;
      line-height: 2rem;
      text-align: center;
      font-size: 1.5rem;
      background-color: #666;
      color: #222;
      border-radius: 1rem;
      cursor: pointer;
      transition: 0.1s;
      margin-right: 0.5rem;
    }
    
    nav a:hover, nav a:focus {
      background-color: #fff;
      outline: none;
    }
    
    #hr-container {
      position: fixed;
      z-index: -1;
    }
    
    #hr-container hr {
      position: fixed;
      border: none;
      height: 0.125rem;
      background-color: #444;
    }
    
    @keyframes modal-container-enter {from {opacity: 0}}
    #modal-container {
      background-color: #00000088;
      width: 100vw;
      height: 100vh;
      position: fixed;
      z-index: 99999999;
      animation: modal-container-enter 0.3s;
    }
    
    #modal-container[active=false] {
      display: none;
    }
    
    @keyframes modal-enter {from {transform: translate(-50%, -50%) translateY(1rem)}}
    #modal {
      width: 32rem;
      height: calc(80vh - 4rem);
      width: calc(80vh - 4rem);
      padding: 2rem;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      position: absolute;
      background-color: #222;
      border: solid 0.125rem #888;
      color: white;
      border-radius: 0.25rem;
      animation: modal-enter 0.3s;
      overflow-y: scroll;
    }
    
    #modal h1 {
      font-size: 2rem;
      margin: 0;
      margin-top: 2rem;
      text-transform: uppercase;
    }
    
    #modal h2 {
      text-transform: uppercase;
    }
    
    #modal > h2 {
      margin-top: 2.5rem;
      padding-bottom: 0.5rem;
      border-bottom: solid 0.125rem #444;
    }
    
    @keyframes catalogue-div-enter {from {opacity: 0; transform: translateX(-1rem)}}
    #modal .catalogue-div {
      border-left: solid 0.25rem var(--accent);
      padding-left: 1rem;
      margin: 1rem 0;
      animation: catalogue-div-enter 0.5s;
    }
    
    #modal .catalogue-div p {
      margin: 0;
      margin-bottom: 0.5rem;
    }
    
    #modal .catalogue-div button {
      font-family: inherit;
      font-weight: inherit;
      font-size: 1rem;
      padding: 0.5rem 1.5rem;
      background-color: #111;
      border: none;
      color: white;
      text-transform: uppercase;
      margin-top: 0.25rem;
      margin-right: 0.25rem;
      cursor: pointer;
      transition: 0.1s;
      border-radius: 0.25rem;
      
      
      width: 16rem;
      padding: 0.5rem 0;
    }
    
    #modal .catalogue-div button:hover, #modal button:focus {
      background-color: var(--accent);
      outline: none;
    }
    
    #modal p {
      line-height: 150%;
      user-select: text;
    }
    
    #modal a {
      color: #999;
      transition: color 0.1s;
    }
    
    #modal a:hover, #modal a:focus {
      color: #fff;
      outline: none;
    }
    
    #modal span {
      color: #777;
    }
    
    @keyframes special-message-enter {from {transform: translate(-50%, -50%) translateY(0.5rem) scale(0.95); opacity: 0;}}
    #special-message {
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 1.5rem;
      position: absolute;
      left: 50%;
      top: 50%;
      animation: 1s special-message-enter;
    }
    
    #modal > input {
      font-family: inherit;
      background-color: inherit;
      border: none;
      color: white;
      padding: 0.5rem;
      width: 75%;
      border: solid 0.125rem #333;
      font-weight: inherit;
      font-size: 1rem;
      transition: background-color 0.1s;
    }
    
    #modal > input:focus {
      background-color: #333;
      outline: none;
    }
    
    #modal > button {
      display: inline-block;
      font-family: inherit;
      font-size: inherit;
      background-color: inherit;
      border: none;
      color: white;
      padding: 0.5rem;
      width: 4rem;
      margin-left: 1rem;
      border: solid 0.125rem #333;
      font-weight: inherit;
      text-transform: lowercase;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.1s;
    }
    
    #modal > button:hover {
      background-color: #333;
    }
    
    #modal > hr {
      border: none;
      height: 0.125rem;
      background-color: #444;
      margin: 2rem 0;
    }
  </style>
  <style id="custom-css"></style> <!-- updated whenever a new library hits the scene -->
</head>
<body>
  <nav>
    <a onclick="prompt_info()">?</a>
    <a onclick="prompt_addition()">+</a>
  </nav>
  <div id="special-message">right click to add a module</div>
  <main id="main"></main> <!-- contains all the nodes -->
  <div id="hr-container"></div> <!-- contains all the lines lol i hate drawing lines w html -->
  <div id="modal-container" active="false" onclick="close_modal()"><div id="modal" onclick="event.stopPropagation()"></div></div>
  <script>
    let nodes = {}; //master list that you always have to reference
    /*let nodes_history = [nodes]; //history of all past states of nodes
    function commit_node_history() {
      //commited when USER changes something (not on any old update
      nodes_history.push(nodes);
      if (nodes_history.length > 100) {
        nodes_history.shift();
      }
    }
    function undo_node_history() {
      if (nodes_history.length > 1) {
        nodes_history.pop();
        nodes = nodes_history[nodes.length-1];
        for (uuid of Object.keys(nodes))
          update(uuid, 99);
      }
    }*/
    
    //TODO:
    // - undo history (history of all ${nodes})
    // - ui to trash existing nodes
    // - filter manual node inputs instead of using json.parse
    // - only propagate changes if node output has actually changed (requires custom equality function)
    // - dont allow user to set input for linked inputs
    
    /*NODES TODO
    
    RANDOM
    stuff for random on sphere

    FUNCTION
    polynomial evaluate
    polynomial derivative

    STATISTICS
    min q1 med q3 max
    linear regression
    
    LOGIC
    all those logic operations (false = 0, true != 0)
    
    */
    
    
    //instead of memory address pointers, everything is uuids
    let occupied_uuids = [];
    function get_uuid() {
      let txt = "";
      for (let i = 0; i < 8; i++)
        txt += ["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"][Math.floor(Math.random()*16)];
      if (occupied_uuids.includes(txt)) txt = get_uuid();
      occupied_uuids.push(txt);
      return txt;
    }
    
    //preparations for before-input before-output
    function update(uuid, recursion_level) {
      if (recursion_level < 0) {
        prompt_toomuchrecursion();
        return;
      }
      //find its old outputs
      let old_outputs = [];
      for (output of nodes[uuid].outputs) old_outputs.push(output.val);
      //first, fetch its inputs into i
      let inputs = [];
      for (let i = 0; i < nodes[uuid].inputs.length; i++) {
        if (nodes[uuid].inputs[i].source_address == null) {
          inputs.push(nodes[uuid].inputs[i].val);
        } else {
          inputs.push(nodes[nodes[uuid].inputs[i].source_address].outputs[nodes[uuid].inputs[i].source_number]);
        }
      }
      //next, call its calculate function
      let outputs;
      try {
        outputs = nodes[uuid].calculate(inputs, nodes[uuid].internal_state);
        nodes[uuid].internal_state = outputs[1];
        outputs = outputs[0];
      } catch {
        document.getElementById(uuid).setAttribute("errored", "true");
        nodes[uuid].errored = true;
        return;
      }
      document.getElementById(uuid).setAttribute("errored", "false");
      nodes[uuid].errored = false;
      if (old_outputs == outputs) return; //if literally nothing has changed, so be it
      //then, return those o[] into the output variables
      for (let i = 0; i < nodes[uuid].outputs.length; i++) {
        nodes[uuid].outputs[i] = outputs[i];
        document.getElementById(uuid+"-output-label-"+i).innerText = reformat(outputs[i], true);
      }
      //propagate to anyone else
      for (let i = 0; i < nodes[uuid].recipients.length; i++) {
        update(nodes[uuid].recipients[i], recursion_level-1); //TODO: only propagate if our outputs had any meaningful changes lol
      }
      //update our labels
      for (let i = 0; i < nodes[uuid].inputs.length; i++) {
        document.getElementById(uuid+"-input-label-"+i).innerText = reformat(inputs[i], true);
        document.getElementById(uuid+"-input-"+i).setAttribute("connected", nodes[uuid].inputs[i].source_address != null);
      }
      for (let i = 0; i < nodes[uuid].outputs.length; i++)
        document.getElementById(uuid+"-output-label-"+i).innerText = reformat(outputs[i], true);
    }
    function reformat(val, truncate) {
      if (typeof(val) == "number") {
        if (Math.abs(val) < 0.0000001) val = 0;
        val = ""+val;
      } else {
        let txt = "[";
        for (let i = 0; i < val.length; i++) {
          if (i >0) txt += ", ";
          txt += reformat(val[i], truncate);
        }
        txt += "]";
        val = txt;
      }
      if (truncate && val.length > 12)
        return val.substring(0, 9) + "...";
      return val;
    }
    
    //creates a node from catalogue
    function make_node(library_string, node_string, x, y) {
      let catalogue_entry = catalogue[library_string][node_string];
      //create an actual node object from catalogue_entry
      let node = {};
      node.category = library_string; //this is used for category="" attributes. NOT necessarily same as the display name
      node.name = catalogue_entry.name;
      node.inputs = [];
      if (catalogue_entry.inputs != undefined) for (input of catalogue_entry.inputs) {
        node.inputs.push({name: input.name, val: input.val, source_address: null, source_number: null});
      }
      node.outputs = [];
      if (catalogue_entry.outputs != undefined) for (output of catalogue_entry.outputs) {
        node.outputs.push({name: output.name, val: undefined});
      }
      node.buttons = [];
      if (catalogue_entry.buttons != undefined) for (button of catalogue_entry.buttons) {
        node.buttons.push({name: button.name, action: button.action});
      }
      node.calculate = catalogue_entry.calculate; //steal their function definition :3
      node.recipients = [];
      node.errored = false;
      node.internal_state = (catalogue_entry.internal_state == null) ? {} : catalogue_entry.internal_state; //free for each node implementation to use
      //establish uuid
      let uuid = get_uuid();
      node.uuid = uuid;
      nodes[uuid] = node;
      //make element
      let html = '<div class="node" category="'+node.category+'" id="'+uuid+'" style="top: '+y+'px; left: '+x+'px;" onmouseup="click_header_up(\''+uuid+'\')">';
      html += '<header onmousedown="click_header_down(\''+uuid+'\')">'+node.name+'</header>';
      html += '<section><div class="node-inputs">';
      for (let i = 0; i < node.inputs.length; i++) {
        html += '<div class="node-input" connected="false" id="'+uuid+'-input-'+i+'"><div onclick="input_circle_click(\''+uuid+'\', '+i+')" id="'+uuid+'-input-jack-'+i+'">–</div><span onclick="io_click(\''+uuid+'\', true, '+i+')">'+node.inputs[i].name+'</span><label id="'+uuid+'-input-label-'+i+'" contenteditable="true" onfocusin="input_label_focusin(\''+uuid+'\', '+i+');" onfocusout="input_label_focusout(\''+uuid+'\', '+i+');"></label></div>';
      }
      html += '</div><div class="node-outputs">';
      for (let i = 0; i < node.outputs.length; i++) {
        html += '<div class="node-output" id="'+uuid+'-output-'+i+'"><span onclick="io_click(\''+uuid+'\', false, '+i+')">'+node.outputs[i].name+'</span><div id="'+uuid+'-output-jack-'+i+'">&nbsp;</div><label id="'+uuid+'-output-label-'+i+'"></label></div>';
      }
      html += '</div></section>';
      if (node.buttons.length > 0) {
        html += '<div class="node-buttons">';
        for (let i = 0; i < node.buttons.length; i++) {
          html += '<button onclick="button_click(\''+uuid+'\', '+i+')">'+node.buttons[i].name+'</button>';
        }
        html += '</div>';
      }
      html += '<textarea spellcheck="false" placeholder="module notes..."></textarea>';
      html += '</div>';
      document.getElementById("main").insertAdjacentHTML("beforeend", html);
      update(uuid, 100);
      document.getElementById("special-message").style.display = "none";
    }
    //establishes output-to-input connection
    let last_connection_made = {uuid: null, num: null};
    function connect(origin_uuid, origin_number, destination_uuid, destination_number) {
      //store in case of infinite loop
      last_connection_made = {uuid: destination_uuid, num: destination_number};
      //setup number links
      nodes[destination_uuid].inputs[destination_number].source_address = origin_uuid;
      nodes[destination_uuid].inputs[destination_number].source_number = origin_number;
      nodes[origin_uuid].recipients.push(destination_uuid);
      update(destination_uuid, 100);
      //create visual line
      if (all_lines[destination_uuid+"-"+destination_number] != undefined) {
        all_lines[destination_uuid+"-"+destination_number].remove();
        delete all_lines[destination_uuid+"-"+destination_number];
      }
      let line_element = document.createElement("hr");
      line_element.id = destination_uuid + "-hr-" + destination_number;
      document.getElementById("hr-container").appendChild(line_element);
      all_lines[destination_uuid + "-" + destination_number] = line_element;
      recalibrate_line(destination_uuid, destination_number);
    }
    //removes a connection by the wire's destination. returns input to using default
    function remove_connection(destination_uuid, destination_number) {
      if (nodes[destination_uuid].inputs[destination_number].source_address != null) {
        console.log("removing connection to " + nodes[destination_uuid].name + " input " + destination_number);
        let origin_uuid = nodes[destination_uuid].inputs[destination_number].source_address;
        let origin_number = nodes[destination_uuid].inputs[destination_number].source_number;
        nodes[destination_uuid].inputs[destination_number].source_address = null;
        nodes[destination_uuid].inputs[destination_number].source_number = null;
        nodes[origin_uuid].recipients = nodes[origin_uuid].recipients.filter(function(val, index, arr){return val != destination_uuid;});
        if (all_lines[destination_uuid+"-"+destination_number] != undefined) {
          all_lines[destination_uuid+"-"+destination_number].remove();
          delete all_lines[destination_uuid+"-"+destination_number];
        }
        update(destination_uuid, 100);
      }
    }
    //removes a NODE
    function remove_node(uuid) {
      //if anyone cares about us, just remove their input source and update them
      for (recipient of nodes[uuid].recipients) {
        for (let i = 0; i < nodes[recipient].inputs.length; i++) {
          if (nodes[recipient].inputs[i].source_address == uuid) {
            /*nodes[recipient].inputs[i].source_address = null;
            nodes[recipient].inputs[i].source_number = null;
            all_lines[recipient+"-"+i].remove();
            delete all_lines[recipient+"-"+i];*/
            remove_connection(recipient, i);
          }
        }
        update(recipient, 99);
      }
      document.getElementById(uuid).remove();
      delete nodes[uuid];
      if (Object.keys(nodes).length == 0) document.getElementById("special-message").style.display = "block";
    }
    
    let io_selected_input = null;
    let io_selected_output = null;
    function io_click(uuid, is_input, num) {
      //console.log([uuid, is_input, num]);
      let el = document.getElementById(uuid+"-"+(is_input?"input":"output")+"-"+num);
      if (is_input) {
        //if this is already selected, unselect it. otherwise unselect it
        if (io_selected_input != null && io_selected_input[0] == uuid && io_selected_input[1] == num) {
          io_selected_input = null;
          el.setAttribute("selected", "false");
        } else {
          if (io_selected_input != null) //switching case: let old know it's no longer selected
            document.getElementById(io_selected_input[0]+"-input-"+io_selected_input[1]).setAttribute("selected", "false");
          io_selected_input = [uuid, num];
          el.setAttribute("selected", "true");
        }
      } else {
        //if this is already selected, unselect it. otherwise unselect it
        if (io_selected_output != null && io_selected_output[0] == uuid && io_selected_output[1] == num) {
          io_selected_output = null;
          el.setAttribute("selected", "false");
        } else {
          if (io_selected_output != null) //switching case: let old know it's no longer selected
            document.getElementById(io_selected_output[0]+"-output-"+io_selected_output[1]).setAttribute("selected", "false");
          io_selected_output = [uuid, num];
          el.setAttribute("selected", "true");
        }
      }
      if (io_selected_input != null && io_selected_output != null) {
        document.getElementById(io_selected_input[0]+"-input-"+io_selected_input[1]).setAttribute("selected", "false");
        document.getElementById(io_selected_input[0]+"-input-"+io_selected_input[1]).setAttribute("connected", "true");
        document.getElementById(io_selected_output[0]+"-output-"+io_selected_output[1]).setAttribute("selected", "false");
        connect(io_selected_output[0], io_selected_output[1], io_selected_input[0], io_selected_input[1]);
        io_selected_input = null;
        io_selected_output = null;
      }
    }
    function input_circle_click(uuid, num) { //for clicking the little adjacent orb
      if (nodes[uuid].inputs[num].source_address != null) {
        /*nodes[uuid].inputs[num].source_address == null;
        nodes[uuid].inputs[num].source_number == null;*/
        remove_connection(uuid, num);
        document.getElementById(uuid+"-input-"+num).setAttribute("connected", "false");
        update(uuid, 100);
      }
    }
    function button_click(uuid, num) {
      let its_internal_state = nodes[uuid].internal_state;
      let its_inputs = [];
      for (input of nodes[uuid].inputs) {
        if (input.source_address == null)
          its_inputs.push(input.val);
        else
          its_inputs.push(nodes[input.source_address].outputs[input.source_number].val);
      }
      let its_button_action = nodes[uuid].buttons[num].action;
      nodes[uuid].internal_state = its_button_action(its_inputs, its_internal_state);
      update(uuid);
    }
    let all_lines = {}; //indexed by uuid+"-"+input_num. when link established, hr made. when node moves, recalc all involved lines. when link undone, remove line
    function recalibrate_line(destination_uuid, destination_number) {
      let element = all_lines[destination_uuid+"-"+destination_number];
      //stupid element stuff
      let origin_uuid = nodes[destination_uuid].inputs[destination_number].source_address;
      let origin_number = nodes[destination_uuid].inputs[destination_number].source_number;
      if (origin_uuid == null) return; //in case we recalibrate something that shouldnt exist
      let origin_element = document.getElementById(origin_uuid + "-output-jack-" + origin_number);
      let destination_element = document.getElementById(destination_uuid + "-input-jack-" + destination_number);
      //find coordinates
      let origin_rect = origin_element.getBoundingClientRect();
      let destination_rect = destination_element.getBoundingClientRect();
      let origin_x = origin_rect.right-6;
      let origin_y = origin_rect.top-2;
      let destination_x = destination_rect.left+6;
      let destination_y = destination_rect.top-1;
      //set line properties
      let distance = Math.hypot(destination_y-origin_y, destination_x-origin_x);
      let angle = Math.atan2(destination_y-origin_y, destination_x-origin_x);
      let center_x = (origin_x + destination_x) / 2;
      let center_y = (origin_y + destination_y) / 2;
      element.style.width = distance + "px";
      element.style.left = center_x + "px";
      element.style.top = center_y + "px";
      element.style.transform = "translate(-50%, -50%) rotate("+angle+"rad)";
    }
    let current_dragging = null;
    let drag_z_index = 1;
    let mouse = {x: 0, y: 0};
    function click_header_down(uuid) {
      //if (nodes[uuid].errored) return;
      let element = document.getElementById(uuid);
      let og_x = parseInt(element.style.left);
      let og_y = parseInt(element.style.top);
      if (current_dragging == null) {
        current_dragging = {uuid: uuid, og_x: og_x, og_y: og_y, mouse_x: mouse.x, mouse_y: mouse.y, element: element};
      }
      element.setAttribute("dragging", "true");
      drag_z_index++;
      element.style.zIndex = drag_z_index;
    }
    function click_header_up(uuid) {
      let element = document.getElementById(uuid);
      current_dragging = null;
      element.setAttribute("dragging", "false");
    }
    addEventListener('mousemove', (event) => {
      mouse = {x: event.x, y: event.y};
      if (current_dragging != null) {
        //determine change in mouse coords
        let mouse_dx = mouse.x - current_dragging.mouse_x;
        let mouse_dy = mouse.y - current_dragging.mouse_y;
        //enforce changes to node
        current_dragging.element.style.left = (current_dragging.og_x + mouse_dx) + "px";
        current_dragging.element.style.top = (current_dragging.og_y + mouse_dy) + "px";
        //now we have to update lines
        let affected_nodes = [current_dragging.uuid];
        for (recipient of nodes[current_dragging.uuid].recipients)
          affected_nodes.push(recipient);
        let affected_lines_uuid = [];
        let affected_lines_num = [];
        for (affected_node of affected_nodes) {
          for (let i = 0; i < nodes[affected_node].inputs.length; i++) { //first, lines going to us
            if (nodes[affected_node].inputs[i].source_address != null) {
              affected_lines_uuid.push(affected_node);
              affected_lines_num.push(nodes[affected_node].inputs[i].source_number);
            }
          }
        }
        for (let i = 0; i < affected_lines_uuid.length; i++) {
          recalibrate_line(affected_lines_uuid[i], affected_lines_num[i]);
        }
      }
    });
    function input_label_focusout(uuid, num) {
      let new_text = document.getElementById(uuid+"-input-label-"+num).innerText;
      //TODO: replace the simple json.parse to something more robust such that no FUNNY inputs are given!
      let val = JSON.parse(new_text);
      nodes[uuid].inputs[num].val = val;
      update(uuid, 100);
    }
    function input_label_focusin(uuid, num) {
      document.getElementById(uuid+"-input-label-"+num).innerText = reformat(nodes[uuid].inputs[num].val, false);
    }
    //stuff for adding elements.
    document.addEventListener?document.addEventListener("contextmenu",function(t){if (document.getElementById("modal-container").getAttribute("active")!="true")prompt_addition(),t.preventDefault()},!1):document.attachEvent("oncontextmenu",function(){if (document.getElementById("modal-container").getAttribute("active")!="true")prompt_addition(),window.event.returnValue=!1});
    function prompt_addition() {
      if (mouse.x == 0 && mouse.y == 0) return;
      let mouse_x = mouse.x - 128;
      let mouse_y = mouse.y - 16;
      document.getElementById("modal-container").setAttribute("active", "true");
      let html = "<h2>add module</h2>";
      /*html += '<p style="text-align: center; user-select: none;">';
      for (category of Object.keys(catalogue)) {
        html += '<b category="'+category+'" style="width: 0.5rem; height: 0.5rem; background-color: var(--accent); display: inline-block; border-radius: 1rem; margin-right: 0.25rem;">&nbsp;</b>'
      }
      html += '</p>';*/
      html += '<input type="text" id="library-search-textfield" placeholder="search for module or library" oninput="catalogue_search_filter()">';
      for (category of Object.keys(catalogue)) {
        html += '<div category="'+category+'" class="catalogue-div" id="catalogue-div-'+category+'">';
        /*html += '<h2>'+category_display_name+'</h2>';
        html += '<p>'+catalogue[category]._description+'</p>';*/
        html += '<p>'+catalogue[category]._name.toUpperCase()+'<span>: '+catalogue[category]._description.toLowerCase()+'</span></p>';
        for (node of Object.keys(catalogue[category])) {
          if (node.startsWith("_")) continue;
          html += '<button onclick="close_modal(); make_node(\''+category+'\', \''+node+'\', '+mouse_x+', '+mouse_y+')" id="catalogue-button-'+category+'-'+node+'">'+catalogue[category][node].name+'</button>';
        }
        html += '</div>';
      }
      html += '<p id="catalogue-search-noresults"><span>No results</span></p>';
      html += '<h2>import library</h2><input type="text" id="library-import-textfield" placeholder="import library via url"><button onclick="user_load_library()" id="library-import-button">Add</button>';
      html += '<p>Already loaded libraries</p><ul>';
      for (url of loaded_libraries)
        html += '<li><a target="_blank" href="'+url+'">'+url+'</a></li>';
      html += '</ul>';
      //html += '<p id="library-import-errormessage" style="display: none;"><span>that url doesn\'t work</span></p>';
      document.getElementById("modal").innerHTML = html;
      document.getElementById("library-search-textfield").focus();
      catalogue_search_filter();
    }
    function catalogue_search_filter() {
      let textfield = document.getElementById("library-search-textfield");
      let to_find = textfield.value;
      let any_results = false;
      for (category of Object.keys(catalogue)) {
        let in_category_name = catalogue[category]._name.includes(to_find);
        let in_any_node_name = false;
        for (node of Object.keys(catalogue[category])) {
          if (node.startsWith("_")) continue;
          let in_node_name = catalogue[category][node].name.includes(to_find);
          in_any_node_name = in_any_node_name || in_node_name;
          document.getElementById("catalogue-button-"+category+"-"+node).style.display = (in_node_name||in_category_name ? "inline-block" : "none");
        }
        document.getElementById("catalogue-div-"+category).style.display = in_category_name||in_any_node_name ? "block" : "none";
        any_results = any_results || in_category_name || in_any_node_name;
      }
      document.getElementById("catalogue-search-noresults").style.display = any_results ? "none" : "block";
    }
    function close_modal() {
      document.getElementById('modal').innerHTML = '';
      document.getElementById('modal-container').setAttribute('active', 'false');
    }
    function prompt_info() {
      document.getElementById("modal-container").setAttribute("active", "true");
      let html = "<h2>About this project</h2>";
      html += "<p>Hi!</p>";
      html += '<p>This is a modular calculator. It is inspired by <a target="_blank" href="https://docs.blender.org/manual/en/2.79/render/blender_render/materials/nodes/introduction.html">those material nodes you see in Blender</a>, modular synthesis softwares like <a target="_blank" href="https://vcvrack.com/">VCV Rack</a>, and some of the tools I use in my statistics class.</p>';
      html += '<p>The idea behind it is that each function is wrapped up in a module. All a user sees is its inputs and outputs. Modules can also include buttons, which alter internal states.</p>';
      html += '<p>You then chain the outputs from one module into the input of another module to create more complex functionality. My goal is to create a tool that visualizes the process of transforming data through functions (as you can get lost in data transformation on a normal graphing calculator).</p>';
      html += '<p>Wanna try it out? Close this popup and start using it!</p>';
      html += '<h2>Module libraries</h2>';
      html += '<p>By default, this tool comes with 5 libraries, but you can import others via the dialog for adding modules. Each library is a simple .js file.';
      html += '<p>Each module definition in a library includes the following:</p>';
      html += '<ul>';
      html += '<li>category <span>(required)</span></li>';
      html += '<li>name <span>(required)</span></li>';
      html += '<li>internal_state</li>';
      html += '<li>inputs</li>';
      html += '<li>outputs</li>';
      html += '<li>buttons <span>(each button defines an action(state) that returns how the internal state should be altered after the button runs)</span></li>';
      html += '<li>calculate(i, state) <span>(required)</span> <span>(evaluates the function given inputs and current internal state. returns [output values array, new internal stats])</span></li>';
      html += '</ul>';
      html += '<p>Confused? Me too. Look here for examples:</p>';
      html += '<ul>';
      html += '<li><a target="_blank" href="catalogue_math.js">catalogue_math.js</a></li>';
      html += '<li><a target="_blank" href="catalogue_constant.js">catalogue_constant.js</a></li>';
      html += '<li><a target="_blank" href="catalogue_random.js">catalogue_random.js</a></li>';
      html += '<li><a target="_blank" href="catalogue_stats.js">catalogue_stats.js</a></li>';
      html += '<li><a target="_blank" href="catalogue_lists.js">catalogue_lists.js</a></li>';
      html += '</ul>';
      html += '<h2>&nbsp;</h2>';
      html += '<p style="text-align: center;"><span>Made by <a target="_blank" href="https://astronomy487.github.io/">Astro</a></span></p>';
      document.getElementById("modal").innerHTML = html;
    }
    function prompt_toomuchrecursion() {
      document.getElementById("modal-container").setAttribute("active", "true");
      let html = "<h1>Recursion</h1>";
      html += "<p>You just formed an infinite loop.</p>";
      html += "<p><span>A node's output eventually leads back into its own input.</span></p>";
      html += "<p>I'm going to undo that change.</p>";
      remove_connection(last_connection_made.uuid, last_connection_made.num);
      document.getElementById("modal").innerHTML = html;
    }
    
    //if a b are numbers, do f(a, b)
    //otherwise, decompose a and b and return lists of f(a[], b[])
    function recursive_binary(a, b, base_function) {
      let a_num = typeof(a)=="number";
      let b_num = typeof(b)=="number";
      if (a_num && b_num) return base_function(a, b);
      let arr = [];
      let len = 99999999999999;
      if (!a_num) len = Math.min(a.length, len);
      if (!b_num) len = Math.min(b.length, len);
      for (let j = 0; j < len; j++) {
        if (a_num) {
          arr.push(recursive_binary(a, b[j], base_function));
        } else if (b_num) {
          arr.push(recursive_binary(a[j], b, base_function));
        } else {
          arr.push(recursive_binary(a[j], b[j], base_function));
        }
      }
      return arr;
    }
    function recursive_unary(a, base_function) {
      if (typeof(a)=="number") return base_function(a);
      let x = [];
      for (let i = 0; i < a.length; i++)
        x[i] = recursive_unary(a[i], base_function);
      return x;
    }
    function equals(a, b) { //better equality function that recognizes list content
      let a_list = typeof(a) != "number";
      let b_list = typeof(b) != "number";
      if (a_list != b_list) return false;
      if (!a_list) return a == b;
      if (a.length != b.length) return false;
      for (let i = 0; i < a.length; i++)
        if (!equals(a[i], b[i])) return false;
      return true;
    }
    function includes(list, item) { //using better quality function
      for (let i = 0; i < list.length; i++)
        if (equals(list[i], item))
          return true;
      return false;
    }
    function copy(x) {
      if (typeof(x) == "number") return x;
      let k = [];
      for (item of x)
        k.push(copy(item));
      return k;
    }
    
    //templates from which the actual node objects are constructed in make_node
    let catalogue = {};
    let loaded_libraries = [];
    function load_library(url, success, failure) {
      //open script object
      let el = document.createElement("script");
      el.setAttribute("src", url);
      el.setAttribute("type", "text/javascript");
      el.setAttribute("async", false);
      document.body.appendChild(el);
      el.addEventListener("load", function(){
        loaded_libraries.push(url);
        try{success();}catch{}
      });
      el.addEventListener("error", function(er){
        try{failure();}catch{}
      });
      //a bit later, update custom css to house all this
      setTimeout(function(){
        let css = "";
        for (category of Object.keys(catalogue)) {
          css += "*[category="+category+"]{--accent:"+catalogue[category]._color+"}";
        }
        document.getElementById("custom-css").innerHTML = css;
      }, 100);
    }
    function user_load_library() {
      let textfield = document.getElementById("library-import-textfield");
      load_library(textfield.value, function() {
        prompt_addition();
        //document.getElementById("library-import-errormessage").style.display = "none";
      }, function(){
        textfield.value = "";
        //document.getElementById("library-import-errormessage").style.display = "block";
      });
    }
    
    //load_library("catalogue_debug.js");
    load_library("catalogue_math.js");
    load_library("catalogue_constant.js");
    load_library("catalogue_random.js");
    load_library("catalogue_stats.js");
    load_library("catalogue_lists.js");
    load_library("catalogue_logic.js");
    load_library("catalogue_sets.js");
  </script>
  <div id="library-loader"></div>
</body>
</html>