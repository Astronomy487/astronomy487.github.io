<!DOCTYPE html>
<html>
<head>
  <title>Progressionatron 5000</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    
    body {
      font-size: 1.125rem;
      background-color: #111;
      color: #ddd;
      font-family: Inter, sans-serif;
      user-select: text;
      overflow-y: scroll;
      margin: 0;
    }
    
    main, header div {
      width: min(48rem, calc(100vw - 2rem));
      margin: auto;
    }
    
    main {
      padding-bottom: 8rem;
    }
    
    header {
      background-color: #222;
      padding-top: 2rem;
      padding-bottom: 1rem;
      margin-bottom: 2rem;
    }
    
    header h1 {
      font-size: 3rem;
      margin: 1rem 0;
      text-align: center;
      text-transform: uppercase;
      font-weight: bold;
    }
    
    p {
      line-height: 1.75rem;
    }
    
    a {
      text-decoration: underline;
      cursor: pointer;
      color: white;
    }
    
    nav {
      margin-bottom: 1rem;
      border-radius: 0.25rem;
      overflow: hidden;
      text-transform: uppercase;
      font-weight: bold;
      user-select: none;
    }
    
    nav span {
      padding: 0.5rem 0;
      width: 50%;
      display: inline-block;
      text-align: center;
      border: solid #333;
      border-width: 0.125rem 0;
      cursor: pointer;
      font-size: 1rem;
    }
    
    nav span[active="true"] {
      background-color: #333;
    }
    
    nav span:hover {
      background-color: #333;
    }
    
    section {
      display: none;
    }
    
    .quiet {
      color: #888;
    }
    
    ::selection {
      background: white;
      color: black;
    }
    
    /* colors for all 12 notes */
    :root {
      --color0: #DA4C4C;
      --color1: #E89841;
      --color2: #EFCF30;
      --color3: #B2DD3C;
      --color4: #30DC29;
      --color5: #41D9A8;
      --color6: #48E0E0;
      --color7: #32ABDC;
      --color8: #4D58D0;
      --color9: #9E4DD4;
      --color10: #D052CC;
      --color11: #D94F96;
      --accent: gray; /* overridden whenever chord is presented */
    }
    
    /* colored every semitone */
    [root="0"] {--accent: var(--color0)}
    [root="1"] {--accent: var(--color1)}
    [root="2"] {--accent: var(--color2)}
    [root="3"] {--accent: var(--color3)}
    [root="4"] {--accent: var(--color4)}
    [root="5"] {--accent: var(--color5)}
    [root="6"] {--accent: var(--color6)}
    [root="7"] {--accent: var(--color7)}
    [root="8"] {--accent: var(--color8)}
    [root="9"] {--accent: var(--color9)}
    [root="10"] {--accent: var(--color10)}
    [root="11"] {--accent: var(--color11)}
    
    /* colored every fifth */
    [root="0"] {--accent: var(--color0)}
    [root="1"] {--accent: var(--color7)}
    [root="2"] {--accent: var(--color2)}
    [root="3"] {--accent: var(--color9)}
    [root="4"] {--accent: var(--color4)}
    [root="5"] {--accent: var(--color11)}
    [root="6"] {--accent: var(--color6)}
    [root="7"] {--accent: var(--color1)}
    [root="8"] {--accent: var(--color8)}
    [root="9"] {--accent: var(--color3)}
    [root="10"] {--accent: var(--color10)}
    [root="11"] {--accent: var(--color5)}
    
    input {
      font-family: inherit;
      font-size: inherit;
      background-color: inherit;
      border: none;
      color: inherit;
      padding: 0.5rem 0;
      text-align: center;
      display: block;
      border: solid 0.125rem #333;
      border-radius: 0.25rem;
      width: 100%;
    }
    
    input:focus {
      outline: none;
      background-color: #222;
    }
    
    #advanced_results {
      background-color: #222;
      color: white;
    }
    
    hr {
      border: none;
      height: 0.25rem;
      background-color: #555;
      margin: 1rem 0;
    }
    
    .result_chord {
      padding: 0.125rem 1rem;
      cursor: pointer;
      user-select: none;
    }
    
    .result_chord:hover {
      background-color: #333;
    }
    
    .result_chord_name {
      font-weight: bold;
      color: var(--accent);
      display: inline-block;
      vertical-align: middle;
    }
    
    .result_chord_percent {
      background-color: var(--accent);
      display: inline-block;
    }
    
    .result_chord_percent_container {
      border: solid 0.0625rem #aaa;
      color: #aaa;
      border-radius: 0.25rem;
      overflow: hidden;
      display: inline-block;
      width: min(calc(100% - 9rem), 32rem);
      vertical-align: middle;
      float: right;
    }
    
    .result_chord_number {
      float: right;
      margin-right: 0.25rem;
    }
    
    .context_level_heading {
      user-select: none;
      text-align: center;
      background-color: #333;
      margin: 1rem auto;
      padding: 0.25rem 0;
      border-radius: 0.25rem;
      width: 66.7%;
      cursor: pointer;
    }
    
    .context_level_heading:hover {
      background-color: #555;
    }
    
    #advanced_results p, #advanced_results h3 {
      margin: 1rem;
    }
    
    #advanced_results h3 {
      font-weight: bold;
      font-size: 2rem;
    }
    
    #cleaned_return {
      margin: 1rem 0;
      text-align: center;
    }
    
    .inline_chord {
      color: var(--accent);
      font-weight: bold;
    }
    
    h2 {
      font-size: 2rem;
      margin-top: 3rem;
      margin-bottom: -0.5rem;
    }
    
    .library_selector {
      padding: 1rem;
      border: solid 0.125rem #444;
      border-radius: 0.25rem;
      overflow: hidden;
      width: 75%;
      margin: 1.5rem auto;
    }
    
    .library_selector[active="true"] {
      background-color: #333;
    }
    
    .library_selector p:first-child {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: -0.5rem;
      margin-top: 1rem;
    }
    
    .library_selector div { /* active / inactive text */
      text-transform: uppercase;
      font-size: 1rem;
      padding: 1rem 1rem;
      background-color: #333;
      margin: -1rem;
      margin-top: 0;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    
    .library_selector[active="true"] div {
      background-color: #444;
    }
    
    .library_selector div:hover {
      background-color: #555;
    }
  </style>
</head>
<body>
  <header><div>
    <h1>Progressionatron 5000</h1>
    <p style="text-align: center;">!! This project is still in development !!</p>
    <nav id="tab_nav"></nav>
  </div></header>
  <main>
    <section navtext="Progressionatron 5000">
      <input id="prog_input" placeholder="put chord progression here" oninput="find_continuations()">
      <div id="cleaned_return"></div>
      <div id="advanced_results"></div>
    </section>
    <section navtext="about and configuration">
      <h2>Using the Progressionatron 5000</h2>
      <p>This is a tool that can continue chord progressions based on an analysis of existing songs. For example, if you present it with <span class="inline_chord" root="7">Gm7</span> <span class="inline_chord" root="0">C7</span>, it will suggest possible next chords like <span class="inline_chord" root="5">FM7</span> and <span class="inline_chord" root="2">DM7</span>.</p>
      <p>Chord names are prefered in their short forms (e.g. <span class="inline_chord" root="0">CM7</span> instead of <span class="inline_chord" root="0">Cmaj7</span>) but longer forms are usually accepted. You can use this text box to see how your text gets cleaned.</p>
      <input id="test_chord_cleaning_input" placeholder="put chord(s) here" oninput="test_chord_cleaning()">
      <p id="test_chord_cleaning_output" style="text-align: center;">&nbsp;</p>
      <p>Note that this program has no knowledge of actual chord voicing; if you use precise names that specify sharp/flat chord members, only chords spelled in the same way will be identified as similar!</p>
      <h2>How it works</h2>
      <p>It accomplishes this with a lookup table of contexts (always stored transposed such that the first chord's root is C). By transposing and looking up a context, the program shows you the ways that songs tend to continue such a context. To see that lookup table, try <code onclick="console.log(knowledge)">console.log(knowledge)</code> in the JS console. The lookup is generated by <a target="_blank" href="ChordTool.cpp">this C++ program</a> that takes filenames, scans them, and prints the table as a JS object.</p>
      <p>This page uses those same functions translated into JS to accept user input, access the lookup table, and return the results.</p>
      <h2>Libraries</h2>
      <p>Libraries are collections of songs, each with transcribed chord progressions, used as training data for this system. Each library is trained individually and produces its own lookup table, which are later combined.</p>
      <p>Here, you can view each of the libraries I've prepared and set each to be active or inactive.</p>
      <div id="library_selector_container"></div>
    </section>
  </main>
  <script>
    // ================= KNOWLEDGE MANAGEMENT =================
  
    // the patterns detected by the c++ program. each attribute of knowledge object is one Library of sources
    let libraries = [];
    
    libraries.push({
      active: false,
      name: "2 songs from The Real Book",
      description: "Chords taken from The Real Book of jazz progressions. As of right now, it has been trained on African Flower and Misty. Comprised mostly of seventh chords!",
      knowledge: {'Cm7':[[6,'Fm7'],[3,'A#m7'],[3,'Am7'],[1,'Gm7*5'],[1,'Cm7'],[1,'Gm7'],[1,'D#M7'],[1,'Bm7'],[1,'G#7*5'],[2,'C7'],[14,'F7']],'C7*5':[[1,'Fm7']],'CM7':[[1,'F7'],[1,'C7'],[5,'Cm7'],[3,'Am7'],[1,'C#m7'],[1,'Gm7']],'Cm7*5':[[1,'Fm7']],'Cm7 Bm7 G7*5':[[1,'Cm7']],'Cm7 Gm7':[[1,'Cm7']],'C7 Dm7':[[1,'G7']],'CM7 Cm7':[[2,'C7'],[3,'F7']],'C7':[[1,'GM7'],[1,'D7'],[1,'Cm7'],[6,'FM7'],[3,'DM7'],[1,'Am7'],[2,'Fm7'],[1,'FM/A'],[1,'D#7'],[1,'Dm7'],[1,'F6']],'Cm7 F7 GM7':[[3,'Em7']],'Cm7 C7':[[2,'FM7']],'C7 GM7 G7':[[1,'A7']],'Cm7 Fm7':[[2,'D#m7'],[1,'G#M7'],[3,'A#7']],'Cm7 Gm7*5':[[1,'Cm7']],'Cm7 A#m7':[[3,'Gm7']],'C7 FM7':[[4,'Fm7'],[1,'F#m7'],[1,'Cm7']],'Cm7 Fm7 D#m7':[[2,'Cm7']],'Cm7 Cm7 Fm7':[[1,'D#m7']],'Cm7 Am7':[[1,'Em7*5'],[1,'Em7'],[1,'G#m7']],'C7 D#7':[[1,'Fm7']],'Cm7*5 Fm7':[[1,'Fm7']],'C7 DM7':[[3,'Bm7']],'Cm7 D#M7':[[1,'G#7']],'Cm7 Cm7':[[1,'Fm7']],'CM7 F7':[[1,'CM7']],'C7 GM7':[[1,'G7']],'C7 D7':[[1,'Dm7']],'C7 Am7':[[1,'D7']],'CM7 C7':[[1,'D7']],'C7 Cm7':[[1,'A#m7']],'CM7 C#m7':[[1,'F#7']],'Cm7 Bm7':[[1,'G7*5']],'Cm7 G#7*5':[[1,'C#m7']],'Cm7 A#m7 Gm7':[[1,'Dm7*5'],[1,'Dm7'],[1,'F#m7']],'Cm7 Am7 Em7*5':[[1,'Am7']],'Cm7 Gm7*5 Cm7':[[1,'Cm7']],'Cm7*5 Fm7 Fm7':[[1,'A#m7']],'Cm7 Am7 Em7':[[1,'Am7']],'Cm7 Fm7 G#M7':[[1,'C#7']],'Cm7 Gm7 Cm7':[[1,'D#M7']],'Cm7 D#M7 G#7':[[1,'D#M7']],'CM7 F7 CM7':[[1,'C7']],'CM7 C7 D7':[[1,'Dm7']],'C7 D7 Dm7':[[1,'Cm7']],'C7 Cm7 A#m7':[[1,'Gm7']],'Cm7 Am7 G#m7':[[1,'E7*5']],'C7 Fm7':[[2,'A#7']],'CM7 Am7':[[3,'Dm7']],'CM/E':[[1,'Gm7']],'C6':[[1,'Dm7']],'Cm7 F7':[[3,'GM7'],[1,'Dm7'],[2,'A#m7'],[4,'A#M7'],[1,'A#M/D'],[1,'G#7'],[1,'A#6']],'C6 Dm7':[[1,'G7']],'C7 FM/A':[[1,'Cm7']],'CM/E Gm7':[[1,'C7']],'CM7 Gm7':[[1,'C7']],'Cm7 F7 Dm7':[[1,'G7']],'C7 F6':[[1,'Gm7']],'CM7 Cm7 C7':[[2,'FM7']],'Cm7 C7 FM7':[[2,'Fm7']],'C7 FM7 Fm7':[[3,'A#7'],[1,'F7']],'CM7 Cm7 F7':[[3,'GM7']],'C7 DM7 Bm7':[[3,'Em7']],'CM7 Am7 Dm7':[[3,'G7']],'Cm7 Fm7 A#7':[[1,'Gm7'],[1,'D#M/G'],[1,'D#6']],'C7 Am7 D7':[[1,'Gm7']],'Cm7 F7 A#m7':[[2,'D#7']],'C7 Fm7 A#7':[[2,'D#M7']],'Cm7 F7 A#M7':[[2,'A#m7'],[1,'Bm7'],[1,'Fm7']],'Cm7 F7 A#M/D':[[1,'Fm7']],'C7 FM/A Cm7':[[1,'F7']],'CM/E Gm7 C7':[[1,'FM7']],'C7 FM7 F#m7':[[1,'B7']],'CM7 C#m7 F#7':[[1,'A7']],'Cm7 F7 G#7':[[1,'A#m7']],'C7 D#7 Fm7':[[1,'A#7']],'C7 Dm7 G7':[[1,'Cm7']],'C7 FM7 Cm7':[[1,'F7']],'CM7 Gm7 C7':[[1,'FM7']],'Cm7 F7 A#6':[[1,'Cm7']],'C7 F6 Gm7':[[1,'C7']]}
    });
    
    libraries.push({
      active: false,
      name: "Circle of 5ths",
      description: "An experimental library that is obsessed with motion along the circle of fifths and nothing else",
      knowledge: {'Cm':[[1,'Fm'],[1,'Gm']],'CM':[[1,'FM'],[1,'GM']],'Cm7':[[1,'Fm7'],[1,'Gm7']],'CM7':[[1,'FM7'],[1,'GM7']],'C7':[[1,'F7'],[1,'G7']]}
    });
    
    let knowledge = {}; //the copy of knowledge used. composed from the knowledge of several libraries
    
    function click_library(n) {
      libraries[n].active = !libraries[n].active;
      build_knowledge();
      document.getElementById("prog_input").value = "";
    }
    
    //builds the knowledge to be used from libraries
    click_library(0);
    function build_knowledge() {
      knowledge = {};
      let html = "";
      for (let i = 0; i < libraries.length; i++) {
        let lib = libraries[i];
        if (lib.active)
          add_knowledge(lib.knowledge);
        html += "<div class=\"library_selector\" active=\""+(lib.active?"true":"false")+"\">";
        html += "<p>" + lib.name + "</p>";
        html += "<p>" + lib.description + "</p>";
        html += "<div onclick=\"click_library("+i+")\">" + (lib.active ? "active" : "inactive") + "</div>";
        html += "</div>";
      }
      library_selector_container.innerHTML = html;
      //sort all knowledge rules
      for (rule of Object.keys(knowledge)) {
        knowledge[rule].sort((a, b) => (a[0] < b[0]) ? 1 : -1)
      }
    }
    
    //the variables here are named horribly. dont look at them
    function add_knowledge(k) {
      for (key of Object.keys(k)) { //for each entry in the knowledge
        if (!Object.keys(knowledge).includes(key)) { //make sure entry key exists
          knowledge[key] = [];
        }
        let rule = knowledge[key];
        for (continuation of k[key]) {
          //continuation[0] is count, continuation[1] is new chord name. must find it in rule
          let found = false;
          for (possible_continuation of rule) {
            if (possible_continuation[1] == continuation[1]) {
              possible_continuation[0] += continuation[0];
              found = true;
            }
          }
          if (!found) {
            rule.push([continuation[0], continuation[1]]);
          }
        }
      }
    }
    
    
    
    
    
    // ================= NOTE AND CHORD CALCULATIONS =================
    
    let note_names = "C C# D D# E F F# G G# A A# B".split(" ");
    
    //clean chords and transposes them. or maybe gets their root!
    function clean_and_transpose(chord, shift = 0, get_root = false) {
      chord = chord.replaceAll("maj", "M");
      chord = chord.replaceAll("min", "m");
      chord = chord.replaceAll("-", "m");
      chord = chord.replaceAll("aug", "+");
      chord = chord.replaceAll("dim", "*");
      chord = chord.replaceAll("dom", "7");
      for (let i = 0; i < chord.length; i++) {
        let character = chord.charAt(i);
        if (note_names.includes(character)) {
          let before = chord.substring(0, i);
          let after = chord.substring(i+1);
          let note_value = note_names.indexOf(character) + 12;
          while (after.startsWith("#")) {
            note_value++;
            after = after.substring(1);
          }
          while (after.startsWith("b")) {
            note_value--;
            after = after.substring(1);
          }
          note_value += shift;
          if (get_root) return note_value%12;
          chord = before + note_names[note_value%12] + after;
          //check for plain major chords
          if (before == "") {
            let voicing_to_come = after.length > 0 && !after.startsWith("/");
            if (!voicing_to_come) {
              chord = before + note_names[note_value%12] + "M" + after;
            }
          }
        }
      }
      return chord;
    }
    
    //crunch the numbers. return list of the ways you could continue
    function request_continuation(history) {
      let results = [];
      for (let context = 2; context >= 1; context--) {
        if (context > history.length) continue;
        let chord_history = [];
        let offset = clean_and_transpose(history[history.length - context], 0, true);
        for (let i = history.length - context; i < history.length; i++) {
          chord_history.push(clean_and_transpose(history[i], 12-offset));
        }
        let continuations = knowledge[chord_history.join(" ")]; //list of pairs [3, 'Fmaj']. need offset applied still
        if (!continuations) continue;
        let bank = []; //bank of transposed continuations. one for each entry in the knowledge. still contains frequencies
        let total_count = 0;
        for (entry of continuations) {
          bank.push({
            count: entry[0],
            chord: clean_and_transpose(entry[1], offset)
          });
          total_count += entry[0];
        }
        results.push({
          context: context,
          bank: bank,
          total_count: total_count
        });
      }
      return results;
    }
    
    
    
    
    
    // ================= UI INTERACTIONS FOR CHORD TOOL =================
    
    function accept_chord(chord) {
      document.getElementById("prog_input").value = document.getElementById("prog_input").value.trim() + " " + chord;
      find_continuations();
    }
    
    function pick_from_frequency_list(f_list) { //doesn't force any changes, literally just picks
      let list = [];
      for (entry of f_list) {
        for (let i = 0; i < entry.count; i++) {
          list.push(entry.chord);
        }
      }
      return list[Math.floor(Math.random()*list.length)];
    }
    
    //ui for running request_continuation
    function find_continuations() {
      let prog = document.getElementById("prog_input").value.replaceAll("?","*");
      prog = prog.split(",").join(" ").split(" ").filter((str) => str != '');
      if (prog.length == 0) {
        document.getElementById("advanced_results").innerHTML = "";
      } else {
        let report = request_continuation(prog);
        document.getElementById("advanced_results").innerHTML = advanced_results_html(report, prog);
      }
      let return_html = []; //html for the little box that cleans and returns the input prog
      for (element of prog) {
        return_html.push("<span class=\"inline_chord\" root=\""+clean_and_transpose(element, 0, true)+"\">"+clean_and_transpose(element)+"</span>");
      }
      document.getElementById("cleaned_return").innerHTML = return_html.join(" ");
    }
    
    //assumes result has at least one entry
    function advanced_results_html(report, prog) {
      let html = "<hr>";
      //clean_and_transpose(prog[prog.length-1]) //cleaned final chord that might cause error
      if (report.length == 0) {
        //problem: last chord has no lookup
        let problem = prog[prog.length-1];
        return "<hr><h3>Cannot continue this progression</h3><p>There are no instances of a chord like <span class=\"inline_chord\" root=\""+clean_and_transpose(problem, 0, true)+"\">"+clean_and_transpose(problem)+"</span> before. <span class=\"quiet\">Maybe the chord is spelled wrong. If not, then that chord never appeared in the sample.</span></p><hr>";
      }
      for (level of report) {
        html += "<div class=\"context_level_heading\" onclick=\"accept_chord('"+pick_from_frequency_list(level.bank)+"')\">using " + level.context + " chord"+(level.context==1?"":"s")+" of context</div>";
        let proportion_ceiling = level.bank[0].count * 1.3;
        for (cont of level.bank) {
          let chord_name = cont.chord.replaceAll("*", "?");
          html += "<div class=\"result_chord\" root=\""+clean_and_transpose(cont.chord, 0, true)+"\" onclick=\"accept_chord('"+chord_name+"')\">";
          html += "<span class=\"result_chord_name\">" + chord_name + "</span>";
          let proportion_display = 100 * cont.count / proportion_ceiling;
          let proportion_text = Math.round(1000 * cont.count / level.total_count)/10 + "%";
          html += "<span class=\"result_chord_percent_container\"><span class=\"result_chord_percent\" style=\"width: "+proportion_display+"%\">&nbsp;</span><span class=\"result_chord_number\">"+proportion_text+"</span></span>";
          html += "</div>";
        }
        html += "<hr>";
      }
      return html;
    }
    
    
    
    
    
    // ================= OTHER UI INTERACTIONS =================
    
    let sections_list = document.getElementsByTagName("section");
    for (let i = 0; i < sections_list.length; i++) {
      let t = sections_list[i].getAttribute("navtext");
      document.getElementById("tab_nav").innerHTML += "<span onclick=\"open_section("+i+")\" id=\"section_nav_"+i+"\">"+t+"</span>";
    }
    open_section(0);
    function open_section(n) {
      for (let i = 0; i < sections_list.length; i++) {
        sections_list[i].style.display = i==n ? "block" : "none";
        document.getElementById("section_nav_"+i).setAttribute("active", i==n ? "true" : "false");
      }
    }
    
    // + the special thing that makes h1/h2 (always static) rainbows
    for (el of document.getElementsByTagName("h1")) {
      let t = el.innerText;
      let html = "";
      for (let i = 0; i < t.length; i++) {
        html += "<span style=\"color: var(--color"+i%12+")\">"+t.charAt(i)+"</span>";
      }
      el.innerHTML = html;
    }
    for (el of document.getElementsByTagName("h2")) {
      let t = el.innerText;
      let html = "// ";
      for (let i = 0; i < t.length; i++) {
        html += "<span style=\"color: var(--color"+i%12+")\">"+t.charAt(i)+"</span>";
      }
      el.innerHTML = html;
    }
    
    //the special cleaning test
    
    document.getElementById("test_chord_cleaning_input").value = "";
    function test_chord_cleaning() {
      let prog = document.getElementById("test_chord_cleaning_input").value.replaceAll("?","*");
      prog = prog.split(",").join(" ").split(" ").filter((str) => str != '');
      let html = [];
      for (chord of prog) {
        html.push("<span class=\"inline_chord\" root=\""+clean_and_transpose(chord, 0, true)+"\">"+clean_and_transpose(chord)+"</span>");
      }
      if (html.length == 0) html = ["&nbsp;"];
      document.getElementById("test_chord_cleaning_output").innerHTML = html.join(" ");
    }
  </script>
</body>
</html>